{

  "variables": {
    "source_image": "{{ env `IMG_TMP_ID` }}",
    "image_name": "{{ env `IMG_NAME` }}",
    "build_flavor": "16",
    "user":  "{{ env `OS_VERSION` }}",
    "factory_network": "{{ env `NET_ID` }}",
    "factory_security_group_name": "{{env `SG_ID`}}",
    "ansible_dir": "{{ env `ANSIBLE_DIR` }}",
    "data": "sources/v2/packer/cloud-config.yml"
  },


  "builders": [{
    "type": "openstack",
    "image_name": "{{ user `image_name` }}",
    "source_image": "{{ user `source_image` }}",
    "flavor": "16",
    "networks": "{{ user `factory_network` }}",
    "floating_ip_pool": "public",
    "security_groups": ["{{ user `factory_security_group_name` }}"],
    "ssh_username": "{{ user `user`}}"
  }
  ],
  "provisioners": [

    {
      "type": "file",
      "source": "{{ user `data`}}",
      "destination": "/etc/cloud/cloud.cfg"
    },

    {
      "type": "shell",
      "inline": [
        "sleep 30",
        "cat /etc/cloud/cloud.cfg"
      ]
    },

    {
      "type": "ansible",
      "extra_arguments": ["--sudo-user", "{{ user `user` }}","-vvv"],
      "playbook_file": "{{ user `ansible_dir` }}/{{ user `user` }}.yml",
      "host_alias": "packer"

    }
  ]

}